name: Extract and Release

on:
  workflow_dispatch:
    inputs:
      ROM_URL:
        description: "ROM URL"
        default: "https://pixeldrain.com/api/file/StGHtPFc"
      DEVICE_NAME:
        description: "Device Name"
        default: "OnePlus 9R"

jobs:
  extract-rom:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install necessary packages (7-Zip, jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full jq

      - name: Download ROM file
        run: |
          curl -L -w "%{http_code}" ${{ github.event.inputs.ROM_URL }} --output rom.zip -o /dev/null
          if [ $? -ne 0 ]; then
            echo "::error:: Failed to download ROM file!"
            exit 1
          fi

          FILE_TYPE=$(file rom.zip)
          echo "Downloaded file type: $FILE_TYPE"

          if [[ "$FILE_TYPE" != *"Zip archive"* ]]; then
            echo "::error:: The downloaded file is not a valid ZIP archive!"
            exit 1
          fi
          
          FILE_SIZE=$(stat -c%s "rom.zip")
          if [[ "$FILE_SIZE" -lt 10240 ]]; then
            echo "::error:: Downloaded ROM file is too small. Possible download error!"
            exit 1
          fi
          echo "ROM file downloaded and verified as rom.zip."

      - name: Extract ROM using 7-Zip
        run: |
          7z x rom.zip -orom_extracted
          if [ $? -ne 0 ]; then
            echo "::error:: Failed to extract ROM zip!"
            exit 1
          fi
          echo "ROM extracted to rom_extracted directory."
